<!DOCTYPE html>
<html lang="en">
<head>
	<title>Project: Group 3</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
	<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
	<style>
		<!--Table CSS-->

		html,body,h1,h2,h3,h4,h5 {font-family: "Raleway", sans-serif}
		 *{
			box-sizing: border-box;
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
		}
		body{
			font-family: Helvetica;
			-webkit-font-smoothing: antialiased;
			background: gray;
		}
		h2{
			text-align: center;
			font-size: 18px;
			text-transform: uppercase;
			letter-spacing: 1px;
			color: black;
			padding: 30px 0;
		}

		/* Table Styles */

		.table-wrapper{
			margin: 10px 70px 70px;
			box-shadow: 0px 35px 50px rgba( 0, 0, 0, 0.2 );
		}

		.fl-table {
			border-radius: 5px;
			font-size: 12px;
			font-weight: normal;
			border: none;
			border-collapse: collapse;
			width: 100%;
			max-width: 100%;
			white-space: nowrap;
			background-color: white;
		}

		.fl-table td, .fl-table th {
			text-align: center;
			padding: 8px;
		}

		.fl-table td {
			border-right: 1px solid #f8f8f8;
			font-size: 12px;
		}

		.fl-table thead th {
			color: #ffffff;
			background: #4FC3A1;
		}


		.fl-table thead th:nth-child(odd) {
			color: #ffffff;
			background: #324960;
		}

		.fl-table tr:nth-child(even) {
			background: #F8F8F8;
		}

		/* Responsive */

		@media (max-width: 767px) {
			.fl-table {
				display: block;
				width: 100%;
			}
			.table-wrapper:before{
				content: "Scroll horizontally >";
				display: block;
				text-align: right;
				font-size: 11px;
				color: white;
				padding: 0 0 10px;
			}
			.fl-table thead, .fl-table tbody, .fl-table thead th {
				display: block;
			}
			.fl-table thead th:last-child{
				border-bottom: none;
			}
			.fl-table thead {
				float: left;
			}
			.fl-table tbody {
				width: auto;
				position: relative;
				overflow-x: auto;
			}
			.fl-table td, .fl-table th {
				padding: 20px .625em .625em .625em;
				height: 60px;
				vertical-align: middle;
				box-sizing: border-box;
				overflow-x: hidden;
				overflow-y: auto;
				width: 120px;
				font-size: 13px;
				text-overflow: ellipsis;
			}
			.fl-table thead th {
				text-align: left;
				border-bottom: 1px solid #f7f7f9;
			}
			.fl-table tbody tr {
				display: table-cell;
			}
			.fl-table tbody tr:nth-child(odd) {
				background: none;
			}
			.fl-table tr:nth-child(even) {
				background: transparent;
			}
			.fl-table tr td:nth-child(odd) {
				background: #F8F8F8;
				border-right: 1px solid #E6E4E4;
			}
			.fl-table tr td:nth-child(even) {
				border-right: 1px solid #E6E4E4;
			}
			.fl-table tbody td {
				display: block;
				text-align: center;
			}
		}

		/* The popup form - hidden by default */
		.form-popup {
		  display: none;
		  position: center;
		  bottom: 0;
		  right: 20px;
		  border: 7px solid #f1f1f1;
		  z-index: 9;
		}
		

		/* Add styles to the form container */
		.form-container {
		  max-width: 600px;
		  padding: 10px;
		  background-color: white;
		}

		.form_element{
		  display: inline-block;
		  margin:1px;
		  margin-right:10px;
		  width:230px;
		}

		/* Full-width input fields */
		.form-container input[type=text], 
		.form-container input[type=email],
		.form-container input[type=tel],
		.form-container input[type=date],
		.form-container input[type=number],
		.form-container input[type=password],
		.form-container select, 
		.form-container textarea{
		  width: 100%;
		  padding: 15px;
		  margin: 8px 0 22px 0;
		  border: none;
		  background: #f1f1f1;
		}

		/* When the inputs get focus, do something */
		.form-container input[type=text]:focus, 
		.form-container input[type=email]:focus, 
		.form-container input[type=tel]:focus, 
		.form-container input[type=date]:focus, 
		.form-container input[type=number]:focus, 
		.form-container input[type=password]:focus, 
		.form-container select:focus, 
		.form-container textarea:focus {
		  background-color: #ddd;
		  outline: none;
		}

		/* Set a style for the submit/login button */
		.form-container .btn {
		  background-color: #04AA6D;
		  color: white;
		  padding: 15px 20px;
		  border: none;
		  cursor: pointer;
		  width: 100%;
		  margin-bottom:10px;
		  opacity: 0.8;
		}

		/* Add a red background color to the cancel button */
		.form-container .cancel {
		  background-color: red;
		}

		/* Add some hover effects to buttons */
		.form-container .btn:hover, .open-button:hover {
		  opacity: 1;
		
	</style>

</head>
<body class="w3-light-grey">

<!-- Top container -->
<div class="w3-bar w3-top w3-black w3-large" style="z-index:4">
  <button class="w3-bar-item w3-button w3-hide-large w3-hover-none w3-hover-text-light-grey" onclick="w3_open();"><i class="fa fa-bars"></i>  Menu</button>
  <a href="main.html">  <img alt="logo" src='{{url_for("static",filename="images/logo.png")}}' width=150" height="50">  </a>

</div>

<!-- Sidebar/menu -->
<nav class="w3-sidebar w3-collapse w3-white w3-animate-left" style="z-index:3;width:300px;" id="mySidebar"><br>
  <div class="w3-container w3-row">
    <div class="w3-col s4">
      <img src='{{url_for("static",filename="images/manager/b1.png")}}' class="w3-circle w3-margin-right" style="width:46px">
    </div>
    <div class="w3-col s8 w3-bar">
      <span>Welcome, <strong>{{UserName}}</strong></span><br>
      <a href="#" class="w3-bar-item w3-button"><i class="fa fa-envelope"></i></a>
      <a href="#" class="w3-bar-item w3-button"><i class="fa fa-user"></i></a>
      <a href="#" class="w3-bar-item w3-button"><i class="fa fa-cog"></i></a>
    </div>
  </div>
  <hr>
  <div class="w3-container">
  </div>
  <div class="w3-bar-block">
    <a href="#" class="w3-bar-item w3-button w3-padding-16 w3-hide-large w3-dark-grey w3-hover-black" onclick="w3_close()" title="close menu"><i class="fa fa-remove fa-fw"></i>  Close Menu</a>
    <a href="/dashboard" class="w3-bar-item w3-button w3-padding"><i class="fa fa-home fa-fw"></i>  Dashboard</a>
    <a href="/projects" class="w3-bar-item w3-button w3-padding"><i class="fa fa-eye fa-fw"></i>  Projects</a>
    <a href="/tasks" class="w3-bar-item w3-button w3-padding w3-blue"><i class="fa fa-tasks fa-fw"></i>  Tasks</a>
    <a href="/clients" class="w3-bar-item w3-button w3-padding"><i class="fa fa-address-card fa-fw"></i> Clients </a>
    <a href="/employees" class="w3-bar-item w3-button w3-padding"><i class="fa fa-users fa-fw"></i>  Employees</a><br><br>
	<a href="/logout" class="w3-bar-item w3-button w3-padding"><i class="fa fa-sign-out fa-fw"></i>  Logout</a><br><br>
  </div>
</nav>

<!-- Overlay effect when opening sidebar on small screens -->
<div class="w3-overlay w3-hide-large w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

<!-- !PAGE CONTENT! -->
<div class="w3-main" style="margin-left:300px;margin-top:43px;">



  <h2>Project Tasks</h2>
  <div class="table-wrapper">
      <!-- Project tasks table-->
      <a id="createTask">+ Create new Task record</a>
      <table class="fl-table" id="tasksTable">
          <thead>
          <tr>
              <th>id</th>
              <th>Project Name</th>
              <th>Milestone Name</th>
              <th>Task Name</th>
              <th>Task Description</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>% Complete</th>
              <th>Assigned To</th>
              <th>Contact</th>
              <th></th>
              <th></th>
          </tr>
          </thead>
      </table>
      <!-- Task form-->
      <div class="form-popup" id="taskFormContainer">
		  <form class="form-container" id="taskForm">
			<input type="hidden" id="taskid" name="taskid" disabled>
			<input type="hidden" id="projectid" name="projectid" disabled>
			<input type="hidden" id="milestoneid" name="milestoneid" disabled>
			<input type="hidden" id="ownerid" name="ownerid" disabled>
			<input type="hidden" id="contactid" name="contactid" disabled>
			<fieldset>
				<div class="form_element">
					<label for="projectname"><b>Project Name</b></label>
					<div id='projectname'></div>
				</div>
				
				<div class="form_element">
					<label for="milestonename"><b>Milestone Name</b></label>
					<select id="milestonename" required></select>
				</div>
				
				<div class="form_element">	
					<label for="taskname"><b>Task Name</b></label>
					<input type="text" placeholder="Task Name" id="taskname" name="taskname" required>
				</div>
				
				<div class="form_element">
					<label for="description"><b>Description</b></label>
					<input type="text" id="description" name="description" placeholder="Description">
				</div>
				
				<div class="form_element">
					<label for="ownername"><b>Task Owner</b></label>
					<select id="ownername"></select>
				</div>
				
				<div class="form_element">	
					<label for="contactname"><b>Contact Name</b></label>
					<select id="contactname"></select>
				</div>
				
				<div class="form_element">
					<label for="status"><b>Status</b></label>
					<select name="status" id="status" >
						<option value="New" selected="selected">New</option>
						<option value="Active">Active</option>
						<option value="Closed">Closed</option>
						<option value="On Hold">On Hold</option>
						<option value="Cancelled">Cancelled</option>
					</select>
				</div>
				
				<div class="form_element">
					<label for="percentagecomplete"><b>Percentage Complete</b></label>
					<input type="number" placeholder="0%" name="percentagecomplete" id="percentagecomplete" min="0" max="100">
				</div>
				
				<div class="form_element">
					<label for="startdate"><b>Start Date</b></label><br>
					<input type="date" id="startdate" name="startdate" placeholder="yyyy-MM-dd" min="2021-01-01" max="2030-12-31">
				</div>
				
				<div class="form_element">
					<label for="duedate"><b>End date</b></label><br>
					<input type="date" id="duedate" name="duedate" placeholder="yyyy-MM-dd" min="2021-01-01" max="2030-12-31">
				</div>
				
				<div class="form_element">
					<label for="notes"><b>Notes</b></label>
					<textarea id="notes" name="notes" rows="4" cols="30" value=""></textarea>
				</div>
			</fieldset>
			
			<fieldset>
				<div class="form_element">
					<button type="submit" class="btn">Submit</button>
				</div>
				
				<div class="form_element">
					<button type="button" class="btn cancel" id="task_cancelbtn">Close</button>
				</div>
			</fieldset>
		  </form>
	  </div>
  </div>


  <!-- Footer -->
  <footer class="w3-container w3-padding-16 w3-light-grey">
	<p>&copy; GROUP 3 - Emerging Technologies project </p>
  </footer>

  <!-- End page content -->
</div>

<script>
"use strict";
var tasksTable;

// Get the Sidebar
var mySidebar = document.getElementById("mySidebar");

// Get the DIV with overlay effect
var overlayBg = document.getElementById("myOverlay");

// Toggle between showing and hiding the sidebar, and add overlay effect
function w3_open() {
  if (mySidebar.style.display === 'block') {
    mySidebar.style.display = 'none';
    overlayBg.style.display = "none";
  } else {
    mySidebar.style.display = 'block';
    overlayBg.style.display = "block";
  }
}

// Close the sidebar with the close button
function w3_close() {
  mySidebar.style.display = "none";
  overlayBg.style.display = "none";
}

//Loads projects table
function loadTasksTable(){
	tasksTable=$('#tasksTable').DataTable({
		ajax:  {
			"url": "/gettasks",
			"type": "POST",
			"data": {},
			"dataSrc":""
		},
		columns: [
			{ data: "_id",
				"visible": false,
				"searchable": false },
			{ data: "projectid",
				"render": function ( data, type, row, meta ) {
					return '<a href="/projects?projectid='+data+'">'+row['projectname']+'</a>';
			}},
			{ data: "milestoneid",
				"render": function ( data, type, row, meta ) {
					return '<a href="/projects?milestoneid='+data+'">'+row['milestonename']+'</a>';
			}},
			{ data: "taskname" },
			{ data: "description" },
			{ data: "duedate" },
			{ data: "status" },
			{ data: "percentagecomplete" },
			{ data: "ownerid",
				"render": function ( data, type, row, meta ) {
					if(row['ownername'] == null){
						return 'None';
					}else{
						return '<a href="/employees?userid='+data+'">'+row['ownername']+'</a>';
					}
				}
			},
			{ data: "contactid",
				"render": function ( data, type, row, meta ) {
					if(data == null){
						return 'None';
					}else{
						return '<a href="/clients?contactid='+data+'">'+row['contact']['firstname']+' '+ row['contact']['lastname']+'</a>';
					}
				}
			},
			{
				data: null,
				className: "dt-center editor-edit",
				defaultContent: '<i class="fa fa-pencil"/>',
				orderable: false
			},
			{
				data: null,
				className: "dt-center editor-delete",
				defaultContent: '<i class="fa fa-trash"/>',
				orderable: false
			}
		]
	});
}

//refresh task data
function refreshTasksTable(){
	$('#tasksTable').DataTable().ajax.reload();
}

//reload milestone, owner, and contact dropdowns
function refreshDropDown(){
	var data={};
	if($("#projectid").val() !=''){
		data = {"projectid": $("#projectid").val()};
	}else if($("#projectname").val() !=''){
		data = {"projectid": $("#projectname").val()};
	}
	//load milestone dropdown
	$.ajax({
		"url": "/getmilestones",
		"type": "POST",
		"data": data,
		"success":function(response){
			$("#milestonename").empty();
			$("#milestonename").append("<option>Select Milestone</option>");
			var len = response.length;
			for( var i = 0; i<len; i++){
				var id = response[i]['milestoneid'];
				var name = response[i]['milestonename'];
				$("#milestonename").append("<option value='"+id+"'>"+name+"</option>");
				$("#milestonename").val($("#milestoneid").val());
			}
		}
	});
	//Load Owner dropdown
	$.ajax({
		"url": "/getprjteam",
		"type": "POST",
		"data": data,
		"success":function(response){
			$("#ownername").empty();
			$("#ownername").append("<option>Assigned To</option>");
			var len = response.length;
			for( var i = 0; i<len; i++){
				var id = response[i]['prjteamid'];
				var name = response[i]['firstname']+' '+response[i]['lastname'];
				$("#ownername").append("<option value='"+id+"'>"+name+"</option>");
				$("#ownername").val($("#ownerid").val());
			}
		}
	});
	//Load Contacts dropdown
	$.ajax({
		"url": "/getcontacts",
		"type": "POST",
		"data": data,
		"success":function(response){
			$("#contactname").empty();
			$("#contactname").append("<option>Select Contact</option>");
			var len = response.length;
			for( var i = 0; i<len; i++){
				var id = response[i]['_id'];
				var name = response[i]['firstname']+' '+response[i]['lastname'];
				$("#contactname").append("<option value='"+id+"'>"+name+"</option>");
				$("#contactname").val($("#contactid").val());
			}
		}
	});
}

//Close form
function closeTasksForm(){
	$("#taskForm").trigger("reset");
	$("#taskid").removeAttr("value");
	$("#projectid").removeAttr("value");
	$("#milestoneid").removeAttr("value");
	$("#ownerid").removeAttr("value");
	$("#contactid").removeAttr("value");
	var projectname_div = $('<div/>',{
		text : "",
		id : $("#projectname").attr('id')
	});
	$("#projectname").replaceWith(projectname_div);
	$("#milestonename").empty();
	$("#ownername").empty();
	$("#contactname").empty();
	
	$("#taskFormContainer").css("display","None");
	$(window).scrollTop($("#createTask").offset().top);
}

//Submit form
function submitTasks(){
	var taskid = $("#taskid").val();
	var projectid = $("#projectid").val();
	var milestoneid = $("#milestonename").val();
	var ownerid = $("#ownername").val();
	var contactid = $("#contactname").val();
	
	var taskname = $("#taskname").val();
	var milestonename = $("#milestonename option:selected").text();
	var ownername = $("#ownername option:selected").text();
	var contactname = $("#contactname option:selected").text();
	
	var description = $("#description").val();
	var notes = $("#notes").val();
	var status = $("#status").val();
	var percentagecomplete = $("#percentagecomplete").val();
	
	var startdate = $("#startdate").val();
	var duedate = $("#duedate").val();
	
	var url;
	if (taskid != ""){
		url = "/updatetask";
		var projectname = $("#projectname").text();
		var projectid = $("#projectid").val();
	}else{
		url = "/createtask";
		var projectname = $("#projectname option:selected").text();
		var projectid = $("#projectname").val();
	}
	
	var data = {
		"taskid": taskid,
		"taskname": taskname,
		"projectid": projectid,
		"projectname": projectname,
		"milestoneid": milestoneid,
		"milestonename": milestonename,
		"ownerid": ownerid,
		"ownername": ownername,
		"contactid": contactid,
		"contactname": contactname,
		"description": description,
		"status": status,
		"percentagecomplete": percentagecomplete,
		"startdate": startdate,
		"duedate": duedate,
		"notes": notes
	};
	$.ajax({
		"url": url,
		"data": data,
		"type": "POST",
		"success": function(data){
			closeTasksForm();
			alert("success");
			refreshTasksTable();
		},
		"error": function(XMLHttpRequest, textStatus, errorThrown) {
			var err = JSON.parse(XMLHttpRequest.responseText);
			alert(err.Message);
		}
	});
}

//delete record
function deleteTask(row){
	if (confirm("Please confirm you wish to delete")) {
		$.ajax({
			"url": "/deletetask",
			"data": {"taskid":row._id},
			"type": "POST",
			"success": function(data){
				refreshTasksTable();
				alert("Success");
			},
			"error": function(XMLHttpRequest, textStatus, errorThrown) {
				var err = JSON.parse(XMLHttpRequest.responseText);
				alert(err.Message);
			}
		});
	}
}


$(document).ready(function(){
	loadTasksTable();
	// New task record
    $('#createTask').on('click', function (e) {
        closeTasksForm();
		var projectname_div = $('<select/>',{
			id : "projectname",
			required : true,
			onchange : "refreshDropDown()"
		});
		$("#projectname").replaceWith(projectname_div);
		$.ajax({
			"url": "/getprojects",
			"type": "POST",
			"data": {},
			"success":function(response){
				$("#projectname").empty();
				$("#projectname").append("<option>Select Project</option>");
				var len = response.length;
				for( var i = 0; i<len; i++){
					var id = response[i]['_id'];
					var name = response[i]['projectname'];
					$("#projectname").append("<option value='"+id+"'>"+name+"</option>");
				}
			}
		});
		
        $("#taskFormContainer").css("display","block");
		$("#projectname").focus();
        e.preventDefault();
    });

    // Edit task record
    $('#tasksTable').on('click', 'td.editor-edit', function (e) {
		closeTasksForm();
		var row  = tasksTable.row(this).data()
		
		$("#taskid").val(row._id);
		$("#projectid").val(row.projectid);
		$("#milestoneid").val(row.milestoneid);
		$("#ownerid").val(row.ownerid);
		$("#contactid").val(row.contactid);
		$("#taskname").val(row.taskname);
		$("#description").val(row.description);
		$("#notes").val(row.notes);
		$("#status").val(row.status);
		$("#percentagecomplete").val(row.percentagecomplete);
		if(row.startdate){
			$("#startdate").val(new Date(row.startdate).toISOString().substr(0, 10));
		}
		if(row.startdate){
			$("#duedate").val(new Date(row.duedate).toISOString().substr(0, 10));
		}
		refreshDropDown();
		var projectname_div = $('<div/>',{
			text : row.projectname,
			id : "projectname"
		});
		$("#projectname").replaceWith(projectname_div);
		
        $("#taskFormContainer").css("display","block");
		$("#taskname").focus();
		
        e.preventDefault();
    });

    // Delete record
    $('#tasksTable').on('click', 'td.editor-delete', function (e) {
        var row  = taskTable.row(this).data()
		deleteTask(row);
		e.preventDefault();
    });
	
	// Cancel button
    $('#task_cancelbtn').on('click', function (e) {
		closeTasksForm();
        e.preventDefault();
    });
	
	// Submit button
    $('#taskForm').on('submit', function (e) {
		submitTasks();
        e.preventDefault();
    });
});
</script>

</body>
</html>